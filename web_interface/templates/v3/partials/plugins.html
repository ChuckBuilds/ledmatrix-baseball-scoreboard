<div class="bg-white rounded-lg shadow p-6">
    <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Plugin Management</h2>
        <p class="mt-1 text-sm text-gray-600">Manage installed plugins, configure settings, and browse the plugin store.</p>
    </div>

    <!-- Plugin Controls -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center space-x-4">
            <button id="refresh-plugins-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Plugins
            </button>
            <button id="restart-display-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-redo mr-2"></i>Restart Display
            </button>
        </div>
    </div>

    <!-- Plugin Content Area -->
    <div id="plugins-content" class="space-y-8">
        <!-- Installed Plugins Section (Always visible at top) -->
        <div id="installed-plugins-section">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Installed Plugins</h3>
                <span id="installed-count" class="text-sm text-gray-500">0 installed</span>
            </div>
            <div id="installed-plugins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Plugins will be loaded here -->
            </div>
        </div>

        <!-- Plugin Store Section (Always visible at bottom) -->
        <div id="plugin-store-section" class="border-t border-gray-200 pt-8">
            <!-- GitHub Auth Warning Banner -->
            <div id="github-auth-warning" class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>Limited API Access:</strong> GitHub API requests are limited to <span id="rate-limit-count">60</span> per hour without authentication.
                            Add a GitHub token to increase this to 5,000 requests/hour and get real-time plugin stats.
                        </p>
                        <p class="mt-2 text-sm text-yellow-700">
                            <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="font-medium underline hover:text-yellow-800">
                                Create a GitHub Token →
                            </a>
                            <span class="mx-2">|</span>
                            <a href="#" onclick="event.preventDefault(); showGithubTokenInstructions()" class="font-medium underline hover:text-yellow-800">
                                Setup Instructions
                            </a>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="dismissGithubWarning()" class="text-yellow-700 hover:text-yellow-900">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Plugin Store</h3>
                <span id="store-count" class="text-sm text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
                </span>
            </div>
            <div class="mb-4">
                <div class="flex space-x-4">
                    <input type="text" id="plugin-search" placeholder="Search plugins..." class="form-control text-sm flex-1 px-3 py-2 border border-gray-300 rounded-md">
                    <select id="plugin-category" class="form-control text-sm w-48 px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Categories</option>
                        <option value="sports">Sports</option>
                        <option value="content">Content</option>
                        <option value="time">Time</option>
                        <option value="weather">Weather</option>
                        <option value="financial">Financial</option>
                        <option value="media">Media</option>
                        <option value="demo">Demo</option>
                    </select>
                    <button id="search-plugins-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
                    </div>
            <div id="plugin-store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Loading skeleton -->
                <div class="store-loading col-span-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Plugin Configuration Modal -->
    <div id="plugin-config-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="plugin-config-title" class="text-lg font-semibold">Plugin Configuration</h3>
                <button id="close-plugin-config" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="plugin-config-content">
                <!-- Plugin config form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    console.log('Plugin manager script starting...');
    
    // Local variables for this instance
let installedPlugins = [];
let currentPluginConfig = null;
    let pluginStoreCache = null; // Cache for plugin store to speed up subsequent loads
    let cacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

// Initialize when DOM is ready or when HTMX loads content
window.initPluginsPage = function() {
    initializePlugins();

    // Event listeners (remove old ones first to prevent duplicates)
    const refreshBtn = document.getElementById('refresh-plugins-btn');
    const restartBtn = document.getElementById('restart-display-btn');
    const searchBtn = document.getElementById('search-plugins-btn');
    const closeBtn = document.getElementById('close-plugin-config');
    
    if (refreshBtn) {
        refreshBtn.replaceWith(refreshBtn.cloneNode(true));
        document.getElementById('refresh-plugins-btn').addEventListener('click', refreshPlugins);
    }
    if (restartBtn) {
        restartBtn.replaceWith(restartBtn.cloneNode(true));
        document.getElementById('restart-display-btn').addEventListener('click', restartDisplay);
    }
    if (searchBtn) {
        searchBtn.replaceWith(searchBtn.cloneNode(true));
        document.getElementById('search-plugins-btn').addEventListener('click', searchPluginStore);
    }
    if (closeBtn) {
        closeBtn.replaceWith(closeBtn.cloneNode(true));
        document.getElementById('close-plugin-config').addEventListener('click', closePluginConfigModal);
    }
}

// Initialize immediately when script loads (HTMX has already swapped content)
console.log('Plugin manager script loaded, initializing...');
// Small delay to ensure DOM is fully painted
setTimeout(function() {
    console.log('Checking for plugin elements...');
    if (document.getElementById('installed-plugins-grid')) {
        console.log('Plugin elements found, initializing now!');
        initPluginsPage();
    } else {
        console.error('Plugin elements not found!');
    }
}, 100);

function initializePlugins() {
    console.log('Initializing plugins...');

    // Check GitHub authentication status
    checkGitHubAuthStatus();

    // Load both installed plugins and plugin store
    loadInstalledPlugins();
    searchPluginStore(); // Load plugin store with no filters

    // Setup search functionality
    document.getElementById('plugin-search').addEventListener('input', debounce(searchPluginStore, 300));
    document.getElementById('plugin-category').addEventListener('change', searchPluginStore);

    console.log('Plugins initialized');
}

function loadInstalledPlugins() {
    console.log('Loading installed plugins...');

    fetch('/api/v3/plugins/installed')
        .then(response => {
            console.log('Installed plugins response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Installed plugins data:', data);

            if (data.status === 'success') {
                installedPlugins = data.data.plugins || [];
                console.log('Installed plugins count:', installedPlugins.length);
                renderInstalledPlugins(installedPlugins);

                // Update count
                const countEl = document.getElementById('installed-count');
                if (countEl) {
                    countEl.textContent = installedPlugins.length + ' installed';
                }
            } else {
                showError('Failed to load installed plugins: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading installed plugins:', error);
            showError('Error loading plugins: ' + error.message);
        });
}

function renderInstalledPlugins(plugins) {
    const container = document.getElementById('installed-plugins-grid');
    
    // Update global installedPlugins for navigation tabs
    window.installedPlugins = plugins;
    console.log('Set window.installedPlugins to:', plugins.length, 'plugins');
    
    // Trigger the main app to update plugin tabs
    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
        const appElement = document.querySelector('[x-data="app()"]');
        if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
            appElement._x_dataStack[0].installedPlugins = plugins;
            appElement._x_dataStack[0].updatePluginTabs();
            console.log('Triggered Alpine.js to update plugin tabs');
        }
    }

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-plug text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No plugins installed</p>
                <p class="text-sm text-gray-500 mt-1">Install plugins from the store to get started</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h4 class="font-medium text-gray-900">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">✓ Verified</span>' : ''}
                        ${plugin.enabled ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Enabled</span>' : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded ml-2">Disabled</span>'}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><i class="fas fa-user mr-1"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p><i class="fas fa-tag mr-1"></i>v${plugin.version || '1.0.0'}</p>
                        <p><i class="fas fa-folder mr-1"></i>${escapeHtml(plugin.category || 'General')}</p>
                        <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags ? `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${plugin.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Plugin Actions -->
            <div class="flex space-x-2">
                <button onclick="configurePlugin('${plugin.id}')"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-cog mr-1"></i>Configure
                </button>
                <button onclick="updatePlugin('${plugin.id}')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-sync mr-1"></i>Update
                </button>
                <button onclick="uninstallPlugin('${plugin.id}')"
                        class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-trash mr-1"></i>Uninstall
                </button>
            </div>
        </div>
    `).join('');
}

// Helper function to update toggle text dynamically
function updateToggleText(checkbox) {
    const statusText = document.getElementById('enabled-status-text');
    if (statusText) {
        statusText.textContent = checkbox.checked ? 'Enabled' : 'Disabled';
    }
}

window.configurePlugin = function(pluginId) {
    console.log('Switching to plugin tab:', pluginId);
    
    // Switch to the plugin's dedicated tab using Alpine.js
    const appElement = document.querySelector('[x-data="app()"]');
    if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
        appElement._x_dataStack[0].activeTab = pluginId;
        console.log('Switched to tab:', pluginId);
    } else {
        // Fallback: try to trigger the tab button click
        const pluginTab = document.querySelector(`.plugin-tab[onclick*="${pluginId}"]`);
        if (pluginTab) {
            pluginTab.click();
            console.log('Clicked plugin tab button');
        } else {
            console.error('Could not find plugin tab for:', pluginId);
            showNotification('Plugin tab not found. Please refresh the page.', 'error');
        }
    }
}

function showPluginConfigModal(pluginId, config) {
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');

    console.log('Showing modal for:', pluginId);
    title.textContent = `Configure ${pluginId}`;
    
    // Show loading state while form is generated
    content.innerHTML = '<div class="flex items-center justify-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i></div>';
    
    // Show modal immediately
    modal.style.display = 'flex';
    console.log('Modal display set to flex');
    
    // Generate form asynchronously
    generatePluginConfigForm(pluginId, config)
        .then(formHtml => {
            console.log('Form generated, setting content');
            content.innerHTML = formHtml;
        })
        .catch(error => {
            console.error('Error generating config form:', error);
            content.innerHTML = '<p class="text-red-600">Error loading configuration form</p>';
        });
}

function generatePluginConfigForm(pluginId, config) {
    // Load plugin schema for dynamic form generation
    return fetch(`/api/v3/plugins/schema?plugin_id=${pluginId}`)
        .then(response => response.json())
        .then(schemaData => {
            if (schemaData.status === 'success' && schemaData.data.schema) {
                return generateFormFromSchema(schemaData.data.schema, config);
            } else {
                // Fallback to simple form if no schema
                return generateSimpleConfigForm(config);
            }
        })
        .catch(error => {
            console.error('Error loading schema:', error);
            return generateSimpleConfigForm(config);
        });
}

function generateFormFromSchema(schema, config) {
    let formHtml = '<form id="plugin-config-form" class="space-y-4">';

    // Always add the enabled toggle at the top
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    formHtml += `
        <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
            <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                Plugin Status
            </label>
            <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
            </label>
        </div>
    `;

    if (schema.properties) {
        Object.entries(schema.properties).forEach(([key, prop]) => {
            // Skip the 'enabled' property if it's in the schema since we already added it
            if (key === 'enabled') return;

            const value = config[key] !== undefined ? config[key] : prop.default;
            const label = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const description = prop.description || '';

            formHtml += `
                <div class="form-group">
                    <label for="${key}" class="block text-sm font-medium text-gray-700 mb-1">
                        ${label}
                    </label>
            `;

            if (description) {
                formHtml += `<p class="text-sm text-gray-600 mb-2">${description}</p>`;
            }

            // Generate appropriate input based on type
            if (prop.type === 'boolean') {
                formHtml += `
                    <label class="flex items-center">
                        <input type="checkbox" id="${key}" name="${key}" ${value ? 'checked' : ''} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm">Enabled</span>
                    </label>
                `;
            } else if (prop.type === 'number' || prop.type === 'integer') {
                const min = prop.minimum !== undefined ? `min="${prop.minimum}"` : '';
                const max = prop.maximum !== undefined ? `max="${prop.maximum}"` : '';
                const step = prop.type === 'integer' ? 'step="1"' : 'step="any"';
                formHtml += `
                    <input type="number" id="${key}" name="${key}" value="${value || ''}" ${min} ${max} ${step} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                `;
            } else if (prop.type === 'array') {
                const arrayValue = Array.isArray(value) ? value.join(', ') : '';
                formHtml += `
                    <input type="text" id="${key}" name="${key}" value="${arrayValue}" placeholder="Enter values separated by commas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="text-sm text-gray-600 mt-1">Enter values separated by commas</p>
                `;
            } else if (prop.enum) {
                formHtml += `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
                prop.enum.forEach(option => {
                    const selected = value === option ? 'selected' : '';
                    formHtml += `<option value="${option}" ${selected}>${option}</option>`;
                });
                formHtml += `</select>`;
            } else {
                // Default to text input
                const maxLength = prop.maxLength || '';
                formHtml += `
                    <input type="text" id="${key}" name="${key}" value="${value || ''}" ${maxLength ? `maxlength="${maxLength}"` : ''} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                `;
            }

            formHtml += `</div>`;
        });
    }

    formHtml += `
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-200">
            <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Cancel
            </button>
            <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
        </div>
    </form>
    `;

    return Promise.resolve(formHtml);
}

function generateSimpleConfigForm(config) {
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    return `
        <form id="plugin-config-form" class="space-y-4">
            <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
                <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                    Plugin Status
                </label>
                <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                    <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
                </label>
            </div>

            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                <textarea name="config" class="form-control h-32" placeholder="Plugin configuration JSON">${JSON.stringify(config, null, 2)}</textarea>
            </div>

            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2">
                    Cancel
                </button>
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">
                    Save Configuration
                </button>
            </div>
        </form>
    `;
}

window.closePluginConfigModal = function() {
        const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
        currentPluginConfig = null;
    console.log('Modal closed');
}

window.updatePlugin = function(pluginId) {
    showNotification(`Updating ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            loadInstalledPlugins(); // Refresh the list
        }
    })
    .catch(error => {
        showNotification('Error updating plugin: ' + error.message, 'error');
    });
}

window.uninstallPlugin = function(pluginId) {
    const plugin = installedPlugins.find(p => p.id === pluginId);
    const pluginName = plugin ? (plugin.name || pluginId) : pluginId;

    if (!confirm(`Are you sure you want to uninstall ${pluginName}?`)) {
        return;
    }

    showNotification(`Uninstalling ${pluginName}...`, 'info');

    fetch('/api/v3/plugins/uninstall', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Uninstall response:', data);
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Remove from local array immediately for better UX
            installedPlugins = installedPlugins.filter(p => p.id !== pluginId);
            renderInstalledPlugins(installedPlugins);

            // Also refresh from server to ensure consistency
            setTimeout(() => {
                loadInstalledPlugins();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error uninstalling plugin:', error);
        showNotification('Error uninstalling plugin: ' + error.message, 'error');
    });
}

function refreshPlugins() {
    loadInstalledPlugins();
    searchPluginStore();
    showNotification('Plugins refreshed', 'success');
}

function restartDisplay() {
    fetch('/api/v3/system/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'start_display' })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
    })
    .catch(error => {
        showNotification('Error restarting display: ' + error.message, 'error');
    });
}

function searchPluginStore() {
    console.log('Searching plugin store...');
    const query = document.getElementById('plugin-search').value;
    const category = document.getElementById('plugin-category').value;

    // Check if we can use cached data (only for non-filtered requests)
    const now = Date.now();
    const isCacheValid = pluginStoreCache && cacheTimestamp && (now - cacheTimestamp < CACHE_DURATION);
    
    if (!query && !category && isCacheValid) {
        console.log('Using cached plugin store data');
        renderPluginStore(pluginStoreCache);
        const countEl = document.getElementById('store-count');
        if (countEl) {
            countEl.innerHTML = `${pluginStoreCache.length} available`;
        }
        return;
    }

    // Show loading state
    const countEl = document.getElementById('store-count');
    if (countEl) {
        countEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
    }
    showStoreLoading(true);

    let url = '/api/v3/plugins/store/list';
    const params = new URLSearchParams();
    if (query) params.append('query', query);
    if (category) params.append('category', category);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    console.log('Store URL:', url);

    fetch(url)
        .then(response => {
            console.log('Store response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Store data:', data);
            showStoreLoading(false);
            
            if (data.status === 'success') {
                const plugins = data.data.plugins || [];
                console.log('Store plugins count:', plugins.length);
                
                // Cache the results if no filters
                if (!query && !category) {
                    pluginStoreCache = plugins;
                    cacheTimestamp = Date.now();
                    console.log('Cached plugin store data');
                }
                
                renderPluginStore(plugins);

                // Update count
                if (countEl) {
                    countEl.innerHTML = `${plugins.length} available`;
                }
            } else {
                showError('Failed to search plugin store: ' + data.message);
                if (countEl) {
                    countEl.innerHTML = 'Error loading';
                }
            }
        })
        .catch(error => {
            console.error('Error searching plugin store:', error);
            showStoreLoading(false);
            showError('Error searching plugin store: ' + error.message);
            if (countEl) {
                countEl.innerHTML = 'Error loading';
            }
        });
}

function showStoreLoading(show) {
    const loading = document.querySelector('.store-loading');
    if (loading) {
        loading.style.display = show ? 'block' : 'none';
    }
}

function renderPluginStore(plugins) {
    const container = document.getElementById('plugin-store-grid');

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-store text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No plugins found</p>
                <p class="text-sm text-gray-500 mt-1">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h4 class="font-medium text-gray-900">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">✓ Verified</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><i class="fas fa-user mr-1"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p><i class="fas fa-tag mr-1"></i>${escapeHtml(plugin.category || 'General')}</p>
                        <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags ? `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${plugin.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Store Actions -->
            <div class="flex space-x-2">
                <button onclick="installPlugin('${plugin.id}')"
                        class="btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-download mr-1"></i>Install
                </button>
                <button onclick="window.open('${plugin.repo || '#'}', '_blank')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-external-link-alt mr-1"></i>View
                </button>
            </div>
        </div>
    `).join('');
}

// Expose functions to window for onclick handlers
window.installPlugin = function(pluginId) {
    showNotification(`Installing ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Refresh both installed plugins and store
            loadInstalledPlugins();
            searchPluginStore();
        }
    })
    .catch(error => {
        showNotification('Error installing plugin: ' + error.message, 'error');
    });
}

function showError(message) {
    const content = document.getElementById('plugins-content');
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
            <p class="text-red-600">${escapeHtml(message)}</p>
        </div>
    `;
}

// Plugin configuration form submission
document.addEventListener('submit', function(e) {
    if (e.target.id === 'plugin-config-form') {
        e.preventDefault();

        const formData = new FormData(e.target);
        const config = {};

        // Get the enabled checkbox state (unchecked checkboxes don't appear in FormData)
        const enabledCheckbox = document.getElementById('enabled');
        config.enabled = enabledCheckbox ? enabledCheckbox.checked : true;

        // Convert form data to config object
        for (let [key, value] of formData.entries()) {
            // Skip enabled since we already handled it
            if (key === 'enabled') continue;

            if (key === 'display_duration') {
                config[key] = parseInt(value);
            } else {
                config[key] = value;
            }
        }

        // Save the configuration
        savePluginConfiguration(currentPluginConfig.pluginId, config);
    }
});

function savePluginConfiguration(pluginId, config) {
    // Update the plugin configuration in the backend
    fetch('/api/v3/plugins/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plugin_id: pluginId, config })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            closePluginConfigModal();
            // Refresh the installed plugins to update the UI
            loadInstalledPlugins();
        }
    })
    .catch(error => {
        showNotification('Error saving plugin configuration: ' + error.message, 'error');
    });
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// GitHub Authentication Status
function checkGitHubAuthStatus() {
    fetch('/api/v3/plugins/store/github-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const authData = data.data;

                // Show warning if not authenticated
                if (!authData.authenticated) {
                    // Check if user has dismissed the warning (stored in session storage)
                    const dismissed = sessionStorage.getItem('github-auth-warning-dismissed');
                    if (!dismissed) {
                        const warning = document.getElementById('github-auth-warning');
                        const rateLimit = document.getElementById('rate-limit-count');

                        if (warning && rateLimit) {
                            rateLimit.textContent = authData.rate_limit;
                            warning.classList.remove('hidden');
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking GitHub auth status:', error);
        });
}

window.dismissGithubWarning = function() {
    const warning = document.getElementById('github-auth-warning');
    if (warning) {
        warning.classList.add('hidden');
        // Remember dismissal for this session
        sessionStorage.setItem('github-auth-warning-dismissed', 'true');
    }
}

window.showGithubTokenInstructions = function() {
    const instructions = `
        <div class="space-y-4">
            <h4 class="font-semibold text-lg">How to Add a GitHub Token</h4>
            
            <div class="space-y-3">
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 1: Create a GitHub Token</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>Click the "Create a GitHub Token" link above (or <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="text-blue-600 underline">click here</a>)</li>
                        <li>Give it a name like "LEDMatrix Plugin Manager"</li>
                        <li>No special scopes/permissions are needed for public repositories</li>
                        <li>Click "Generate token" at the bottom</li>
                        <li>Copy the generated token (it starts with "ghp_")</li>
                    </ol>
                </div>
                
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 2: Add Token to LEDMatrix</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>SSH into your Raspberry Pi</li>
                        <li>Edit the secrets file: <code class="bg-gray-200 px-1 rounded">nano ~/LEDMatrix/config/config_secrets.json</code></li>
                        <li>Find the "github" section and add your token:
                            <pre class="bg-gray-800 text-white p-2 rounded mt-2 text-xs overflow-x-auto">"github": {
  "api_token": "ghp_your_token_here"
}</pre>
                        </li>
                        <li>Save the file (Ctrl+O, Enter, Ctrl+X)</li>
                        <li>Restart the web service: <code class="bg-gray-200 px-1 rounded">sudo systemctl restart ledmatrix-web</code></li>
                    </ol>
                </div>
                
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> Your token is stored locally and never shared. It's only used to authenticate API requests to GitHub.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeInstructionsModal()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Got it!
                </button>
            </div>
        </div>
    `;
    
    // Use the existing plugin config modal for instructions
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');
    
    title.textContent = 'GitHub Token Setup';
    content.innerHTML = instructions;
    modal.style.display = 'flex';
    console.log('GitHub instructions modal opened');
}

window.closeInstructionsModal = function() {
    const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
    console.log('Instructions modal closed');
}

})(); // End IIFE
</script>
