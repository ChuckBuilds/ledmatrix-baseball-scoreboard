<div class="bg-white rounded-lg shadow p-6">
    <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Plugin Management</h2>
        <p class="mt-1 text-sm text-gray-600">Manage installed plugins, configure settings, and browse the plugin store.</p>
    </div>

    <!-- Plugin Controls -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center space-x-4">
            <button id="refresh-plugins-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Plugins
            </button>
            <button id="restart-display-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-redo mr-2"></i>Restart Display
            </button>
        </div>
    </div>

    <!-- Plugin Content Area -->
    <div id="plugins-loading" class="hidden animate-pulse" style="display: none;">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
            <div class="bg-gray-200 rounded-lg p-4 h-24"></div>
            <div class="bg-gray-200 rounded-lg p-4 h-24"></div>
            <div class="bg-gray-200 rounded-lg p-4 h-24"></div>
            <div class="bg-gray-200 rounded-lg p-4 h-24"></div>
            <div class="bg-gray-200 rounded-lg p-4 h-24"></div>
        </div>
    </div>

    <div id="plugins-content" class="space-y-8">
        <!-- Installed Plugins Section (Always visible at top) -->
        <div id="installed-plugins-section">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Installed Plugins</h3>
                <span id="installed-count" class="text-sm text-gray-500">0 installed</span>
            </div>
            <div id="installed-plugins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Plugins will be loaded here -->
            </div>
        </div>

        <!-- Plugin Store Section (Always visible at bottom) -->
        <div id="plugin-store-section" class="border-t border-gray-200 pt-8">
            <!-- GitHub Auth Warning Banner -->
            <div id="github-auth-warning" class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>Limited API Access:</strong> GitHub API requests are limited to <span id="rate-limit-count">60</span> per hour without authentication.
                            Add a GitHub token to increase this to 5,000 requests/hour and get real-time plugin stats.
                        </p>
                        <p class="mt-2 text-sm text-yellow-700">
                            <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="font-medium underline hover:text-yellow-800">
                                Create a GitHub Token →
                            </a>
                            <span class="mx-2">|</span>
                            <a href="#" onclick="event.preventDefault(); showGithubTokenInstructions()" class="font-medium underline hover:text-yellow-800">
                                Setup Instructions
                            </a>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="dismissGithubWarning()" class="text-yellow-700 hover:text-yellow-900">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Plugin Store</h3>
                <span id="store-count" class="text-sm text-gray-500">Loading...</span>
            </div>
            <div class="mb-4 space-y-3">
                <div class="flex space-x-4">
                    <input type="text" id="plugin-search" placeholder="Search plugins..." class="form-control text-sm flex-1 px-3 py-2 border border-gray-300 rounded-md">
                    <select id="plugin-category" class="form-control text-sm w-48 px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Categories</option>
                        <option value="sports">Sports</option>
                        <option value="content">Content</option>
                        <option value="time">Time</option>
                        <option value="weather">Weather</option>
                        <option value="financial">Financial</option>
                        <option value="media">Media</option>
                        <option value="demo">Demo</option>
                    </select>
                    <button id="search-plugins-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>

                <!-- Tags Filter -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Filter by tags:</label>
                    <div id="tags-filter" class="flex flex-wrap gap-2">
                        <!-- Popular tags will be populated here -->
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="sports">sports</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="scoreboard">scoreboard</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="ticker">ticker</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="clock">clock</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="weather">weather</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="news">news</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="financial">financial</button>
                        <button type="button" class="tag-filter-btn bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded transition-colors"
                                data-tag="demo">demo</button>
                    </div>
                    <button id="clear-tags-btn" class="text-xs text-blue-600 hover:text-blue-800 underline">Clear</button>
                </div>
            </div>
            <div id="plugin-store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Store plugins will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Plugin Configuration Modal -->
    <div id="plugin-config-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="plugin-config-title" class="text-lg font-semibold">Plugin Configuration</h3>
                <button id="close-plugin-config" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="plugin-config-content">
                <!-- Plugin config form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Plugin Manager functionality
// Properly scoped variables and functions for this partial

// Global variables for this partial's scope
let installedPlugins = [];
let currentPluginConfig = null;
let selectedTags = new Set();
let loadingStates = { installed: false, store: false };

// Plugin Manager App Object (make available globally)
window.pluginManager = {
    async loadInstalledPlugins() {
    console.log('Loading installed plugins...');
    loadingStates.installed = true;
        this.checkAndShowLoading();

        try {
            const response = await fetch('/api/v3/plugins/installed');
            const data = await response.json();

            if (data.status === 'success') {
                installedPlugins = data.data.plugins || [];
                console.log('Installed plugins count:', installedPlugins.length);
                this.renderInstalledPlugins(installedPlugins);

                // Update count
                const countEl = document.getElementById('installed-count');
                if (countEl) {
                    countEl.textContent = installedPlugins.length + ' installed';
                }

                // Update main app's plugin list for navigation tabs
                console.log('Updating main app plugin tabs...');

                // Update the global installed plugins array that the main app uses
                window.installedPlugins = installedPlugins;
                console.log('Updated global installedPlugins array:', installedPlugins.length, 'plugins');

                // Trigger reactivity updates
                setTimeout(() => {
                    // Trigger custom event for main app
                    const event = new CustomEvent('pluginsUpdated', {
                        detail: { plugins: installedPlugins }
                    });
                    document.dispatchEvent(event);
                    console.log('Dispatched pluginsUpdated event');

                    // Force Alpine.js reactivity update
                    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
                        document.querySelector('[x-data="app()"]')._x_forceUpdate?.();
                        console.log('Forced Alpine.js reactivity update');
                    }
                }, 100);
            } else {
                this.showError('Failed to load installed plugins: ' + data.message);
            }
        } catch (error) {
            console.error('Error loading installed plugins:', error);
            loadingStates.installed = false;
            this.checkAndHideLoading();
            this.showError('Error loading plugins: ' + error.message);
        } finally {
            loadingStates.installed = false;
            this.checkAndHideLoading();
        }
    },

    renderInstalledPlugins(plugins) {
    const container = document.getElementById('installed-plugins-grid');
        if (!container) return;

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-plug text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No plugins installed</p>
                <p class="text-sm text-gray-500 mt-1">Install plugins from the store to get started</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => {
            const tags = this.parseTags(plugin.tags);
        return `
        <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="flex items-center space-x-2">
                                <span class="plugin-icon">${this.getPluginIcon(plugin)}</span>
                                <h4 class="font-medium text-gray-900">${this.escapeHtml(plugin.name || plugin.id)}</h4>
                        </div>
                        ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">✓ Verified</span>' : ''}
                        ${plugin.enabled ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Enabled</span>' : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded ml-2">Disabled</span>'}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                            <p><i class="fas fa-user mr-1"></i>${this.escapeHtml(plugin.author || 'Unknown')}</p>
                        <p><i class="fas fa-tag mr-1"></i>v${plugin.version || '1.0.0'}</p>
                            <p><i class="fas fa-folder mr-1"></i>${this.escapeHtml(plugin.category || 'General')}</p>
                        <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                    </div>
                        <p class="text-sm text-gray-700 mt-2">${this.escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${tags.length > 0 ? `
                <div class="flex flex-wrap gap-2 mb-3">
                        ${tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${this.escapeHtml(tag)}</span>`).join(' ')}
                </div>
            ` : ''}

            <!-- Plugin Actions -->
            <div class="flex space-x-2">
                    <button onclick="pluginManager.configurePlugin('${plugin.id}')"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-cog mr-1"></i>Configure
                </button>
                    <button onclick="pluginManager.updatePlugin('${plugin.id}')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-sync mr-1"></i>Update
                </button>
                    <button onclick="pluginManager.uninstallPlugin('${plugin.id}')"
                        class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-trash mr-1"></i>Uninstall
                </button>
            </div>
        </div>
    `;
    }).join('');

        // Update count
        const countEl = document.getElementById('installed-count');
        if (countEl) {
            countEl.textContent = plugins.length + ' installed';
        }
    },

    async searchPluginStore() {
        console.log('Searching plugin store...');
        loadingStates.store = true;
        this.checkAndShowLoading();

        try {
            const query = document.getElementById('plugin-search')?.value || '';
            const category = document.getElementById('plugin-category')?.value || '';

            let url = '/api/v3/plugins/store/list';
            const params = new URLSearchParams();
            if (query) params.append('query', query);
            if (category) params.append('category', category);

            // Add selected tags to the search
            if (selectedTags.size > 0) {
                selectedTags.forEach(tag => {
                    params.append('tags', tag);
                });
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            console.log('Store URL:', url);

            const response = await fetch(url);
            const data = await response.json();

            if (data.status === 'success') {
                const plugins = data.data.plugins || [];
                console.log('Store plugins count:', plugins.length);
                this.renderPluginStore(plugins);

                // Update count
                const countEl = document.getElementById('store-count');
                if (countEl) {
                    countEl.textContent = plugins.length + ' available';
                }
            } else {
                const countEl = document.getElementById('store-count');
                if (countEl) {
                    countEl.textContent = 'Error loading';
                }
            }
        } catch (error) {
            console.error('Error searching plugin store:', error);
            loadingStates.store = false;
            this.checkAndHideLoading();

            const countEl = document.getElementById('store-count');
            if (countEl) {
                countEl.textContent = 'Error loading';
            }
        } finally {
            loadingStates.store = false;
            this.checkAndHideLoading();
        }
    },

    renderPluginStore(plugins) {
        const container = document.getElementById('plugin-store-grid');
        if (!container) return;

        if (plugins.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-store text-4xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600">No plugins found</p>
                    <p class="text-sm text-gray-500 mt-1">Try adjusting your search criteria</p>
                </div>
            `;
            return;
        }

        container.innerHTML = plugins.map(plugin => {
            const tags = this.parseTags(plugin.tags);
            return `
            <div class="bg-gray-50 rounded-lg p-4 border">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <div class="flex items-center space-x-2">
                                <span class="plugin-icon">${this.getPluginIcon(plugin)}</span>
                                <h4 class="font-medium text-gray-900">${this.escapeHtml(plugin.name || plugin.id)}</h4>
                            </div>
                            ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">✓ Verified</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><i class="fas fa-user mr-1"></i>${this.escapeHtml(plugin.author || 'Unknown')}</p>
                            <p><i class="fas fa-tag mr-1"></i>${this.escapeHtml(plugin.category || 'General')}</p>
                            <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                        </div>
                        <p class="text-sm text-gray-700 mt-2">${this.escapeHtml(plugin.description || 'No description available')}</p>
                    </div>
                </div>

                <!-- Plugin Tags -->
                ${tags.length > 0 ? `
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${this.escapeHtml(tag)}</span>`).join(' ')}
                    </div>
                ` : ''}

                <!-- Store Actions -->
                <div class="flex space-x-2">
                    <button onclick="pluginManager.installPlugin('${plugin.id}')"
                            class="btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex-1">
                        <i class="fas fa-download mr-1"></i>Install
                    </button>
                    <button onclick="window.open('${plugin.repo || '#'}', '_blank')"
                            class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                        <i class="fas fa-external-link-alt mr-1"></i>View
                    </button>
                </div>
            </div>
        `;
        }).join('');
    },

    async installPlugin(pluginId) {
        this.showNotification(`Installing ${pluginId}...`, 'info');

        try {
            const response = await fetch('/api/v3/plugins/install', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await response.json();

            this.showNotification(data.message, data.status);

            if (data.status === 'success') {
                // Refresh both installed plugins and store
                await this.loadInstalledPlugins();
                await this.searchPluginStore();
            }
        } catch (error) {
            this.showNotification('Error installing plugin: ' + error.message, 'error');
        }
    },

    async uninstallPlugin(pluginId) {
        const plugin = installedPlugins.find(p => p.id === pluginId);
        const pluginName = plugin ? (plugin.name || pluginId) : pluginId;

        if (!confirm(`Are you sure you want to uninstall ${pluginName}?`)) {
            return;
        }

        this.showNotification(`Uninstalling ${pluginName}...`, 'info');

        try {
            const response = await fetch('/api/v3/plugins/uninstall', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await response.json();

            console.log('Uninstall response:', data);
            this.showNotification(data.message, data.status);
            if (data.status === 'success') {
                // Remove from local array immediately for better UX
                installedPlugins = installedPlugins.filter(p => p.id !== pluginId);
                this.renderInstalledPlugins(installedPlugins);

                // Update main app's plugin list and tabs
                console.log('Updating main app after uninstall...');

                // Update the global installed plugins array
                window.installedPlugins = installedPlugins;
                console.log('Updated global installedPlugins array after uninstall');

                // Trigger reactivity updates
                setTimeout(() => {
                    const event = new CustomEvent('pluginsUpdated', {
                        detail: { plugins: installedPlugins }
                    });
                    document.dispatchEvent(event);
                    console.log('Dispatched pluginsUpdated event after uninstall');

                    // Force Alpine.js reactivity update
                    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
                        document.querySelector('[x-data="app()"]')._x_forceUpdate?.();
                        console.log('Forced Alpine.js reactivity update after uninstall');
                    }
                }, 100);

                // Also refresh from server to ensure consistency
                setTimeout(() => {
                    this.loadInstalledPlugins();
                }, 500);
            }
        } catch (error) {
            console.error('Error uninstalling plugin:', error);
            this.showNotification('Error uninstalling plugin: ' + error.message, 'error');
        }
    },

    async updatePlugin(pluginId) {
        this.showNotification(`Updating ${pluginId}...`, 'info');

        try {
            const response = await fetch('/api/v3/plugins/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plugin_id: pluginId })
            });
            const data = await response.json();

            this.showNotification(data.message, data.status);
            if (data.status === 'success') {
                await this.loadInstalledPlugins(); // Refresh the list
            }
        } catch (error) {
            this.showNotification('Error updating plugin: ' + error.message, 'error');
        }
    },

    async configurePlugin(pluginId) {
    console.log('Configuring plugin:', pluginId);

        try {
    // Load plugin configuration
            const response = await fetch(`/api/v3/plugins/config?plugin_id=${pluginId}`);
            const data = await response.json();

            console.log('Plugin config data:', data);
            if (data.status === 'success') {
                currentPluginConfig = { pluginId, config: data.data };
                await this.showPluginConfigModal(pluginId, data.data);
            } else {
                this.showNotification('Failed to load plugin configuration: ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error loading plugin configuration:', error);
            this.showNotification('Error loading plugin configuration: ' + error.message, 'error');
}
    },

    async showPluginConfigModal(pluginId, config) {
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');

        if (!modal || !title || !content) {
            console.error('Plugin config modal elements not found');
            return;
        }

    // Find the plugin to get its icon
    const plugin = installedPlugins.find(p => p.id === pluginId);
        const iconHTML = plugin ? this.getPluginIcon(plugin) : '<i class="fas fa-puzzle-piece"></i>';
    const pluginName = plugin ? (plugin.name || pluginId) : pluginId;

    title.innerHTML = `${iconHTML} Configure ${pluginName}`;
        content.innerHTML = await this.generatePluginConfigForm(pluginId, config);

    modal.classList.remove('hidden');
    },

    async generatePluginConfigForm(pluginId, config) {
        try {
    // Load plugin schema for dynamic form generation
            const schemaResponse = await fetch(`/api/v3/plugins/schema?plugin_id=${pluginId}`);
            const schemaData = await schemaResponse.json();

            if (schemaData.status === 'success' && schemaData.data.schema) {
                return this.generateFormFromSchema(schemaData.data.schema, config);
            } else {
                // Fallback to simple form if no schema
                return this.generateSimpleConfigForm(config);
            }
        } catch (error) {
            console.error('Error loading schema:', error);
            return this.generateSimpleConfigForm(config);
}
    },

    generateFormFromSchema(schema, config) {
    let formHtml = '<form id="plugin-config-form" class="space-y-4">';

    // Always add the enabled toggle at the top
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    formHtml += `
        <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
            <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                Plugin Status
            </label>
            <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
            </label>
        </div>
    `;

    if (schema.properties) {
        Object.entries(schema.properties).forEach(([key, prop]) => {
            // Skip the 'enabled' property if it's in the schema since we already added it
            if (key === 'enabled') return;

            const value = config[key] !== undefined ? config[key] : prop.default;
            const label = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const description = prop.description || '';

            formHtml += `
                <div class="form-group">
                    <label for="${key}" class="block text-sm font-medium text-gray-700 mb-1">
                        ${label}
                    </label>
            `;

            if (description) {
                formHtml += `<p class="text-sm text-gray-600 mb-2">${description}</p>`;
            }

            // Generate appropriate input based on type
            if (prop.type === 'boolean') {
                formHtml += `
                    <label class="flex items-center">
                        <input type="checkbox" id="${key}" name="${key}" ${value ? 'checked' : ''} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm">Enabled</span>
                    </label>
                `;
            } else if (prop.type === 'number' || prop.type === 'integer') {
                const min = prop.minimum !== undefined ? `min="${prop.minimum}"` : '';
                const max = prop.maximum !== undefined ? `max="${prop.maximum}"` : '';
                const step = prop.type === 'integer' ? 'step="1"' : 'step="any"';
                formHtml += `
                    <input type="number" id="${key}" name="${key}" value="${value || ''}" ${min} ${max} ${step} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                `;
            } else if (prop.type === 'array') {
                const arrayValue = Array.isArray(value) ? value.join(', ') : '';
                formHtml += `
                    <input type="text" id="${key}" name="${key}" value="${arrayValue}" placeholder="Enter values separated by commas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <p class="text-sm text-gray-600 mt-1">Enter values separated by commas</p>
                `;
            } else if (prop.enum) {
                formHtml += `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
                prop.enum.forEach(option => {
                    const selected = value === option ? 'selected' : '';
                    formHtml += `<option value="${option}" ${selected}>${option}</option>`;
                });
                formHtml += `</select>`;
            } else {
                // Default to text input
                const maxLength = prop.maxLength || '';
                formHtml += `
                    <input type="text" id="${key}" name="${key}" value="${value || ''}" ${maxLength ? `maxlength="${maxLength}"` : ''} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                `;
            }

            formHtml += `</div>`;
        });
    }

    formHtml += `
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-200">
                <button type="button" onclick="pluginManager.closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Cancel
            </button>
            <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
        </div>
    </form>
    `;

        return formHtml;
    },

    generateSimpleConfigForm(config) {
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    return `
        <form id="plugin-config-form" class="space-y-4">
            <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
                <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                    Plugin Status
                </label>
                <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                    <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
                </label>
            </div>

            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                <textarea name="config" class="form-control h-32" placeholder="Plugin configuration JSON">${JSON.stringify(config, null, 2)}</textarea>
            </div>

            <div class="flex justify-end space-x-2">
                    <button type="button" onclick="pluginManager.closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2">
                    Cancel
                </button>
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">
                    Save Configuration
                </button>
            </div>
        </form>
    `;
    },

    closePluginConfigModal() {
        const modal = document.getElementById('plugin-config-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        currentPluginConfig = null;
    },

    refreshPlugins() {
        this.loadInstalledPlugins();
        this.searchPluginStore();
        this.showNotification('Plugins refreshed', 'success');
    },

    restartDisplay() {
    fetch('/api/v3/system/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'start_display' })
    })
    .then(response => response.json())
    .then(data => {
            this.showNotification(data.message, data.status);
    })
    .catch(error => {
            this.showNotification('Error restarting display: ' + error.message, 'error');
        });
    },

    showNotification(message, type = 'info') {
        // Use the main app's notification system if available
        if (window.app && window.app.showNotification) {
            window.app.showNotification(message, type);
            } else {
            console.log(`Plugin Manager: ${type.toUpperCase()} - ${message}`);
        }
    },

    showLoading() {
    const loadingEl = document.getElementById('plugins-loading');
    const contentEl = document.getElementById('plugins-content');
    if (loadingEl && contentEl) {
        // Force show loading skeleton
        loadingEl.style.display = '';
        loadingEl.classList.remove('hidden');
        // Force hide content
        contentEl.style.display = 'none';
        contentEl.classList.add('hidden');
    }
    },

    hideLoading() {
    const loadingEl = document.getElementById('plugins-loading');
    const contentEl = document.getElementById('plugins-content');
    if (loadingEl && contentEl) {
        // Force hide loading skeleton
        loadingEl.style.display = 'none';
        loadingEl.classList.add('hidden');
        // Force show content
        contentEl.style.display = '';
        contentEl.classList.remove('hidden');
    }
    },

    checkAndShowLoading() {
    // Only show loading if either state is loading
    if (loadingStates.installed || loadingStates.store) {
            this.showLoading();
    }
    },

    checkAndHideLoading() {
    // Only hide loading when both are done
    if (!loadingStates.installed && !loadingStates.store) {
            this.hideLoading();
    }
    },

    showError(message) {
    const content = document.getElementById('plugins-content');
        if (content) {
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
                    <p class="text-red-600">${this.escapeHtml(message)}</p>
        </div>
    `;
    content.classList.remove('hidden');
}
    },

    // Utility functions
    parseTags(tags) {
        if (!tags) return [];
        if (Array.isArray(tags)) return tags;
        if (typeof tags === 'string') {
            try {
                const parsed = JSON.parse(tags);
                if (Array.isArray(parsed)) return parsed;
            } catch (e) {
                return tags.split(',').map(t => t.trim()).filter(t => t);
            }
        }
        return [];
    },

    getPluginIcon(plugin) {
        if (plugin.icon) {
            const icon = plugin.icon;
            if (icon.includes('fa-')) {
                return `<i class="${icon}"></i>`;
            }
            if (icon.length <= 4) {
                return `<span style="font-size: 1.1em;">${icon}</span>`;
            }
            if (icon.startsWith('http://') || icon.startsWith('https://') || icon.startsWith('/')) {
                return `<img src="${icon}" alt="" style="width: 16px; height: 16px; vertical-align: middle;">`;
            }
        }
        return '<i class="fas fa-puzzle-piece"></i>';
    },

    escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
};

// Initialize when DOM is ready or when HTMX loads content
function initPluginsPage() {
    console.log('=== PLUGIN MANAGER INITIALIZATION ===');
    console.log('DOM ready, initializing plugin manager...');

    // Verify critical elements exist
    const installedGrid = document.getElementById('installed-plugins-grid');
    const storeGrid = document.getElementById('plugin-store-grid');
    console.log('Critical elements check:', {
        installedGrid: !!installedGrid,
        storeGrid: !!storeGrid
    });

    if (!installedGrid || !storeGrid) {
        console.error('Critical plugin elements not found! Retrying in 500ms...');
        setTimeout(initPluginsPage, 500);
        return;
    }

    // Check GitHub authentication status first (fast operation)
    checkGitHubAuthStatus();

    // Load plugin store first (doesn't depend on installed plugins)
    console.log('Loading plugin store...');
    pluginManager.searchPluginStore();

    // Then load installed plugins
    console.log('Loading installed plugins...');
    pluginManager.loadInstalledPlugins();

    // Setup search functionality
    document.getElementById('plugin-search')?.addEventListener('input', debounce(() => {
        pluginManager.searchPluginStore();
    }, 300));

    document.getElementById('plugin-category')?.addEventListener('change', () => {
        pluginManager.searchPluginStore();
    });

    document.getElementById('search-plugins-btn')?.addEventListener('click', () => {
        pluginManager.searchPluginStore();
    });

    // Setup tags filter
    setupTagFilters();

    // Event listeners for buttons
    document.getElementById('refresh-plugins-btn')?.addEventListener('click', () => {
        pluginManager.refreshPlugins();
    });

    document.getElementById('restart-display-btn')?.addEventListener('click', () => {
        pluginManager.restartDisplay();
    });

    document.getElementById('close-plugin-config')?.addEventListener('click', () => {
        pluginManager.closePluginConfigModal();
    });

    console.log('Plugin manager initialized');
}


// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPluginsPage);
} else {
    // DOM is already ready, initialize now
    initPluginsPage();
}

// Also initialize when HTMX loads this content
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'plugins-content') {
        console.log('HTMX afterSwap event detected for plugins-content, initializing...');
        initPluginsPage();
    }
});

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function updateToggleText(checkbox) {
    const statusText = document.getElementById('enabled-status-text');
    if (statusText) {
        statusText.textContent = checkbox.checked ? 'Enabled' : 'Disabled';
    }
}

function setupTagFilters() {
    // Add event listeners to tag filter buttons
    document.querySelectorAll('.tag-filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tag = this.getAttribute('data-tag');
            toggleTagFilter(tag, this);
        });
    });

    // Add event listener to clear tags button
    document.getElementById('clear-tags-btn')?.addEventListener('click', function() {
        selectedTags.clear();
        updateTagFilterButtons();
        pluginManager.searchPluginStore(); // Refresh search with cleared tags
    });

    console.log('Tag filters initialized');
}

function toggleTagFilter(tag, button) {
    if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
        button.classList.remove('bg-blue-500', 'text-white');
        button.classList.add('bg-gray-100', 'text-gray-800');
    } else {
        selectedTags.add(tag);
        button.classList.remove('bg-gray-100', 'text-gray-800');
        button.classList.add('bg-blue-500', 'text-white');
    }

    console.log('Selected tags:', Array.from(selectedTags));
    pluginManager.searchPluginStore(); // Refresh search with new tag selection
}

function updateTagFilterButtons() {
    document.querySelectorAll('.tag-filter-btn').forEach(button => {
        const tag = button.getAttribute('data-tag');
        if (selectedTags.has(tag)) {
            button.classList.remove('bg-gray-100', 'text-gray-800');
            button.classList.add('bg-blue-500', 'text-white');
        } else {
            button.classList.remove('bg-blue-500', 'text-white');
            button.classList.add('bg-gray-100', 'text-gray-800');
        }
    });
}

// Plugin configuration form submission handler
document.addEventListener('submit', function(e) {
    if (e.target.id === 'plugin-config-form') {
        e.preventDefault();

        const formData = new FormData(e.target);
        const config = {};

        // Get the enabled checkbox state (unchecked checkboxes don't appear in FormData)
        const enabledCheckbox = document.getElementById('enabled');
        config.enabled = enabledCheckbox ? enabledCheckbox.checked : true;

        // Convert form data to config object
        for (let [key, value] of formData.entries()) {
            if (key === 'enabled') continue;

            if (key === 'display_duration') {
                config[key] = parseInt(value);
            } else {
                config[key] = value;
            }
        }

        // Save the configuration
        savePluginConfiguration(currentPluginConfig.pluginId, config);
    }
});

async function savePluginConfiguration(pluginId, config) {
    try {
        const response = await fetch('/api/v3/plugins/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plugin_id: pluginId, config })
        });

        const data = await response.json();

        if (data.status === 'success') {
            pluginManager.closePluginConfigModal();
            pluginManager.showNotification(`Configuration saved for ${pluginId}`, 'success');
            pluginManager.loadInstalledPlugins(); // Refresh the installed plugins to update the UI
        } else {
            throw new Error(data.message || 'Failed to save configuration');
        }
    } catch (error) {
        console.error('Error saving plugin configuration:', error);
        pluginManager.showNotification('Error saving plugin configuration: ' + error.message, 'error');
    }
}

// GitHub Authentication Status
function checkGitHubAuthStatus() {
    fetch('/api/v3/plugins/store/github-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const authData = data.data;

                if (!authData.authenticated) {
                    const dismissed = sessionStorage.getItem('github-auth-warning-dismissed');
                    if (!dismissed) {
                        const warning = document.getElementById('github-auth-warning');
                        const rateLimit = document.getElementById('rate-limit-count');

                        if (warning && rateLimit) {
                            rateLimit.textContent = authData.rate_limit;
                            warning.classList.remove('hidden');
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking GitHub auth status:', error);
        });
}

function dismissGithubWarning() {
    const warning = document.getElementById('github-auth-warning');
    if (warning) {
        warning.classList.add('hidden');
        sessionStorage.setItem('github-auth-warning-dismissed', 'true');
    }
}

console.log('Plugin Manager partial loaded and ready');
</script>
